---
title: 备份与恢复
tags: [mysql,note,innodb,backup,recovery]
comments: true
categories: [MySQL技术内幕-InnoDB存储引擎]
date: 2019-09-17 14:26:59
---

备份工具：mysqldump、ibbackup、replication、xtrabackup、LVM快照备份等。

### 备份与恢复概述

根据备份方法分：

* Hot Backup（热备份）：数据库运行中直接备份，对正在运行的数据库操作无任何影响，也称为Online Backup（在线备份）。
* Cold Backup（冷备份）：数据库停止时备份，一般只需要复制相关的数据库物理文件，也称为Offline Backup（离线备份）。
* Warm Backup（温备份）：数据库运行中进行备份，会对当前数据库操作有所影响，例如需要加全局读锁以保证备份数据的一致性。

按备份后文件的内容分：

* 逻辑备份：备份的文件可读，一般是文本文件，内容一般由一条条SQL语句或者是表内实际数据组成。可观察到出文件的内容，一般适用于数据库的升级、迁移等工作。恢复时间较长。
* 裸文件备份：复制数据库的物理文件，既可以是数据库运行中的复制，也可以是数据库停止运行时直接的数据文件复制，恢复时间较短。

按备份数据的内容：

* 完全备份：对数据库进行一个完成的备份。
* 增量备份：在上次完全备份的基础上，对于更改的数据进行备份。
* 日志备份：针对MySQL DB二进制日志的备份，通过对一个完全备份进行二进制日志的重做（replay）来完成数据库的point-in-time的恢复工作。

MySQl数据库复制（replication）的原理就是异步实时地将二进制日志重做传送并应用到从（slave/standby）数据库。MySQL未提供真正的增量备份方法，大部分通过二进制日志完成增量备份的工作。效率较真正的增量备份低。

增量备份只需要记录当前每页最后的检查点的LSN，若大于之前全备份时的LSN，则备份该页，否则不用备份，是xtrabackup工具增量备份的原理。

数据库备份的一致性要求在备份的时间数据在这一时间点上是一致的。InnoDB engine支持MVCC，实现一致的备份比较简单。可先开启一个事务，然后导出一组相关的表，最后提交，事务的隔离级别必须设置为REPEATABLE READ。

mysqldump备份工具，可通过添加--single-transaction选项获得InnoDB存储引擎的一致性备份（必i 加选项）。

### 冷备

InnoDB engine冷备需要备份MySQL数据库的frm文件，共享表空间文件，独立表空间文件（*.idb），重做日志文件。定期备份MySQL数据库的配置文件my.cnf，有利于恢复的操作。

优点：

* 备份简单，只要复制相关文件即可。
* 备份文件易于在不同操作系统，不同MySQL版本上进行恢复。
* 恢复简单，只需要把文件恢复到指定位置。
* 恢复速度快，不需要执行任何SQL语句，不需要重建索引。

缺点：

* 冷备文件通常比逻辑文件大很大，表空间中存放着很多其他的数据，如undo段，插入缓冲等信息。
* 不总是可以轻易跨平台。操作系统、MySQL的版本、文件大小写敏感和浮点数格式会成为问题。

### 逻辑备份

#### mysqldump
开始用于完成转存数据库备份及不同数据库之间的移植。

语法：

`mysqldump [arguments] > file_name`

参数可通过mysqldump --help查看：

* --single-transaction：保证备份的一致性。备份开始前先执行START TRANSACTION命令，一次获得备份的一致性，只对InnoDB engine有效。启用该参数时需确保没有任何其他任何的DDL语句执行，一致性读并不能隔离DDL操作。
* --lock-tables（-l）：备份过程中依次锁住每个架构下的所有表，一般用于MyISAM engine，当备份时只能对数据库进行读取操作，备份依然可以保证一致性。InnoDB engine不需要使用此参数，用--single-transaction， --lock-tables和--single-transaction互斥，不能同时使用。
* --lock-all-tables（-x）：备份过程中对所有表上锁，避免--lock-tables不能同时锁住所有表的问题。
* --add-drop-database：在CREATE DATABASE前先运行DROP DATABASE。需与--all-databases或--databases选型一起使用。默认情况下到处的文本文件中并不会有CREATE DATABASE，除非指定该参数。
* --master-data [=value]：产生的备份转存文件主要用来建立一个replication。value为1时，转存文件中记录CHANGE MASTER语句，值为2时，CHANGE MASTER语句被写出SQL注释。默认值为空。会自动忽略--lock-tables选项，若没有选用--single-transaction则自动使用--lock-all-tables选项。
* --enents（-E）：备份事件调度器。
* --routines（-R）：备份存储过程和函数。
* --triggers：备份触发器。
* --hex-blob：将BINARY、VARBINARY、BLOG和BIT列类型备份为十六进制的格式。mysqldump文件导出的文本文件上述类型在文本文件模式下可能有些字符不可见，添加此选型会以十六进制的方式显示。
* --tab=path（-T path）：产生TAB分割的数据文件。每张表，mysqldump创建一个包含CREATE TABLE语句的table_name.sql文件，和包含数据的tbl_name.txt文件。可使用--fields-terminated=...，--fields-enclosed-by=...，--fields-optionally-enclosed-by=...，--fields-escaped-by=...，--lines-terminated-by=...来改变默认的分隔符、换行符等。
* --where='where_condition' (-w 'where_condition')：导出给定条件的数据。
* --all-databases: 备份所有数据库
* --databases： 备份指定数据库

#### SELECT...INTO OUTFILE

逻辑备份方法，道出一张表中的数据。

```
SELECT [column 1],[column 2] ...
INTO
OUTFILE 'file_name'
[
{FIELDS | COLUMNS}
[TERMINATED BY 'string']
[[OPTIONALLY] ENCLOSED BY 'char']
[ESCAPED BY 'char']
]
[
LINES
[SATRTING BY 'string']
[TERMINATED BY 'string']
]
FROM TABLE WHERE ...
```
FIELDS[TERMINATED BY 'string']表示每个列的分隔符，[[OPTIONALLY] ENCLOSED BY 'char']表示对于字符串的包含符，[ESCAPED BY 'char']表示转义符。[STARTING BY 'string']表示每行的开始符号，[TERMINATED BY 'string']表示每行的结束符号。没指定FIELDS和LINES选型时的默认值：

```
FLELDS TERMINATED BY '\t' ENCLOSED BY '' ESCAPED BY '\\'
LINES TERMINATED BY '\n' STARTING BY ''
```

file_name表示导出的文件，路径权限必须是mysql：mysql的。

#### 逻辑备份的恢复

mysqldump只需执行文件：

```
mysql -u root -p < test_backup.sql
Enter password:
```
导入时包含了创建和删除数据库的SQL语句，须确保删除架构时，架构目录下没有其他与数据相关的文件。

mysqldump可导出存储过程、导出触发器、导出事件、导出数据，不能导出视图。需导出视图定义或备份视图定义的frm文件，在恢复时进行导入。

#### LOAD DATA INFILE

通过mysqldump-tab或者SELECT INTO OUTFILE导出的数据，可通过命令LOAD DATA INFILE进行导入。

```
[REPLACE | IGNORE] 
INTO TABLE tbl_name
[CHARACTER SET charset_name]
[
{FIELDS | COLUMNS}
[TERMINATED BY 'string']
[[OPTIONALLY] ENCLOSED BY 'char']
[ESCAPED BY 'char']
]
[
LINE 
[STARTING BY 'string']
[TERMINATED BY 'string']
]
[IGNORE number LINES]
[(col_name_or_user_var,...)]
[SET col_name=expr,...]
```
需拥有INFILE权限。导入格式的选项同SELECT INTO OUTFILE命令一致。IGNORE number LINES可忽略导入的前几行。


#### mysqlimport
MySQL DB提供的命令行程序，时LOAD DATA INFILE的命令接口，大多数选项与LOAD DATA INFILE语法相同。

`mysqlimport [option] db_name textfile1 [textfile2 ...]`

该命令可用来导入多张表，通过--user-thread参数并发导入不同的文件。

### 二进制日志备份与恢复

可通过二进制日志完成point-in-time的恢复工作。MySQL DB replication同样需要二进制日志。默认并不启用二进制日志，需先启用。在配置文件中配置

```
[mysqld]
log-bin=mysql-bin
sync-binlog=1
innodb_support_xa=1
```
备份二进制日志文件前，可通过FLUSH LOGS命令生成一个新的二进制日志文件，然后备份之前的二进制日志文件。

恢复二进制日志，通过mysqlbinlog：

```
mysqlbinlog [options] log_file | mysql -u root -p
```
恢复多个二进制日志文件应该同时恢复，而不是一个一个地恢复。

```
mysqlbinlog binlog.[0-10]* | mysql -u root -p
```
可通过mysqlbinlog导入到一个文件再通过SOURCE命令导入：

```
mysqlbinlog binlog_file1 > binglog_file
mysqlbinlog binlog_file2 >> binlog_file
mysql -u root -p -e "scorce binlog_file"
```

--start-position和--stop-position选项可指定二进制日志的某个偏移量来进行恢复，可跳过某些不正确的语句。--start-datetime和--stop-datetime选项可用来指定从二进制的某个时间点进行恢复。用法一致。

```
mysqlbinglog --start-position=199512 binlog_file | mysql -u root -p
```

### 热备

#### ibbackup
InnoDB engine提供的热备份工具，可同时备份MyISAM engine和InnoDB engine。

对InnoDB engine table备份工作原理：

* 记录备份开始时，InnoDB engine重做日志文件检查点的LSN。
* 复制共享表空间文件以及独立表空间文件。
* 记录复制完成表空间文件后，InnoDB engine重做日志文件检查点的LSN。
* 复制在备份时产生的重做日志

优点：

* 在线备份，不阻塞任何SQL语句。
* 备份性能好，实质是复制数据库文件和重做日志文件。
* 支持压缩备份，通过选项，可支持不同级别的压缩。
* 跨平台支持，ibbackup可运行在Linux、Windows以及主流的Unix系统平台上。

ibbackup恢复InnoDB engine table：

* 恢复表空间文件。
* 应用重做日志文件。


xtrabackup实现了ibbackup的功能，拓展支持了真正的增量备份功能。


#### xtrabackup
网址：[xtrabackup](https://launchpad.net/percona-xtrabackup)。

命令：

```
xtrabackup --backup | --prepare [OPTIONS]
```

开始备份时，首先记录重做日志的位置，然后对备份的InnoDB engine table的物理文件，即共享表空间文件和独立表空间文件进行复制，最后记录备份完成后的重做日志位置。

#### xtrabackup实现增量备份

原理：

1. 先完成一个全备，记录下此时额检查点LSN。
2. 增量备份时，比较表空间中每个页的LSN是否大于上次备份时的LSN，是则备份该页，同时记录当前检查点的LSN。

### 快照备份
通过文件系统支持的快照功能对数据库进行备份。前提是将所有数据库文件放在同一文件分区中，然后对分区进行快照操作。支持快照功能的文件系统和设备有FreeBSD的UFS文件系统，Solaris的ZFS文件系统，GUN/Linux的逻辑管理器（Logical Volume Manager，LVM）等。UFS和ZFS的快照实现大致和LVM相似。

LVM使用写时复制（Copy-on-write）技术创建快照。

参阅[Mysql备份系列（4）--lvm-snapshot备份mysql数据(全量+增量）操作记录](https://www.cnblogs.com/kevingrace/p/6129660.html)。

### 复制

复制（replication）是MySQL DB提供的一种高可用高性能解决方案，一般用于建立大型应用。步骤：

* 主服务器（master）把数据更改记录到二进制日志（binlog）中。
* 从服务器（slave）把主服务器的二进制日志复制到自己的中继日志（relay log）中。
* 从服务器重做中继日志中的重做日志，把更改应用到自己的数据库上，以达到数据的最终一致。

实质是一个完全备份加上二进制日志备份的还原。复制是异步实时的，存在主动服务器之间的执行延时。可通过SHOW SLAVE STATUS和SHOW MASTE STATUS查看当前的延时。

主要变量：

变量 | 说明
:-: | :-:
Slave\_IO\_State | 当前IO线程的状态
Master\_Log\_File | 当前同步的主服务器的二进制日志
Read\_Master\_Log\_Pos | 显示当前同步到主服务器上二进制日志的偏移量位置，单位字节。
Relay\_Master\_Log\_File | 当前中继日志同步的二进制日志
Relay\_Log\_File | 显示当前写入的中继日志
Relay\_Log\_Log | 显示当前执行到中继日志的便宜量位置
Slave\_IO\_Running | 从服务器中IO线程的运行状态，YES代表正常
Slave\_SQL\_Running | 从服务器中SQL线程的运行状态，YES代表正常
Exec\_Master\_Log\_Pos | 表示同步到主服务器的二进制日志偏移量的位置，Read\_Master\_Log\_Pos-Exec\_Master\_Log\_Pos可表示当前SQL线程运行的延时，单位是字节。