---
title: 文件
tags: [mysql,note,innodb,file]
comments: true
categories: [MySQL技术内幕-InnoDB存储引擎]
date: 2019-08-16 14:20:30
---

InnoDB存储引擎表的各种类型文件。

* 参数文件：告知MYSQL实例启动时在哪里可以找到数据库文件，并且指定某些初始化参数，这些参数定义了某种内存结构的大小等设置，介绍各种参数的类型。
* 日志文件：记录MySQL实例对某种条件做出响应时写入的文件，如错误的日志文件、二进制日志文件、慢查询日志文件、查询日志文件等。
* socket文件：当用UNIX域套接字方式进行连接时需要的文件。
* pid文件：MySQL实例的进程ID文件。
* MySQL表结构文件：用来存放MySQL表结构定义文件。
* 存储引擎文件：每个存储引擎有自己的文件来保存各种数据。这些存储引擎真正存储了记录和索引等数据。

### 参数文件

默认MySQL实例会按照一定的顺序在指定的位置进行读取，可通过`mysql --help | grep my.cnf`来寻找。

MySQL的mysql架构中记录了访问该实例的权限，当找不到这个架构时，MySQL实例不会启动成功。

#### 什么是参数

可以把数据参数看成一个键/值（Key/Value）对。

MySQL v5.1开始可以通过`information_schema`架构下的`GLOBAL_VARIABLES`试图来进行查找。

```
mysql> select * from global_variables where variable_name like 'innodb_buffer%'\G;
*************************** 1. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_AT_STARTUP
VARIABLE_VALUE: OFF
*************************** 2. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_FILENAME
VARIABLE_VALUE: ib_buffer_pool
*************************** 3. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_DUMP_NOW
VARIABLE_VALUE: OFF
*************************** 4. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_POPULATE
VARIABLE_VALUE: OFF
*************************** 5. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_DUMP_AT_SHUTDOWN
VARIABLE_VALUE: OFF
*************************** 6. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_ABORT
VARIABLE_VALUE: OFF
*************************** 7. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_INSTANCES
VARIABLE_VALUE: 8
*************************** 8. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_SIZE
VARIABLE_VALUE: 4294967296
*************************** 9. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_NOW
VARIABLE_VALUE: OFF
9 rows in set (0.00 sec)
mysql> show variables like 'innodb_buffer%'\G
*************************** 1. row ***************************
Variable_name: innodb_buffer_pool_dump_at_shutdown
        Value: OFF
*************************** 2. row ***************************
Variable_name: innodb_buffer_pool_dump_now
        Value: OFF
*************************** 3. row ***************************
Variable_name: innodb_buffer_pool_filename
        Value: ib_buffer_pool
*************************** 4. row ***************************
Variable_name: innodb_buffer_pool_instances
        Value: 8
*************************** 5. row ***************************
Variable_name: innodb_buffer_pool_load_abort
        Value: OFF
*************************** 6. row ***************************
Variable_name: innodb_buffer_pool_load_at_startup
        Value: OFF
*************************** 7. row ***************************
Variable_name: innodb_buffer_pool_load_now
        Value: OFF
*************************** 8. row ***************************
Variable_name: innodb_buffer_pool_populate
        Value: OFF
*************************** 9. row ***************************
Variable_name: innodb_buffer_pool_size
        Value: 4294967296
9 rows in set (0.00 sec)
```

各版本都支持`SHOW VARIABLES`命令。

#### 参数类型
可分为：

* 动态参数（dynamic）参数，可在MySQL实例运行中进行更改
* 静态（static）参数，在整个实例生命周期内都不得进行更改

可通过SET命令对动态参数值进行更改。

```
SET | [global | session] system_var_name = expr | [@@global. | @@session. | @@]system_var_name= expr
```

global和session关键字表明该参数的修改是基于当前会话还是整个实例的生命周期。有些参数如autocommit只能在会话中进行修改；有些参数如binlog_cache_size修改完后，在整个实例生命周期中都会生效；有些参数如read_buffer_size既可以在会话中修改又可以在整个实例的生命周期内生效。

```
mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> set read_buffer_size=524288;
Query OK, 0 rows affected (0.01 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)
```


```
mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)

mysql> set @@global.read_buffer_size=262144;
Query OK, 0 rows affected (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 262144
1 row in set (0.00 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)
```

动态变量的可修改范围参考MySQL官方手册Dynamic System Variables。

修改静态变量报错，提示静态变量是只读的：

```
mysql> set GLOBAL datadir='/db/mysql';
ERROR 1238 (HY000): Variable 'datadir' is a read only variable
```


### 日志文件

记录MySQL数据库的各种类型活动：

* 错误日志（error log）
* 二进制日志（binlog）
* 慢查询日志（slow query log）
* 查询日志（log）

#### 错误日志

对MySQL的启动、运行、关闭过程进行了记录，可通过`SHOW VARIABLES LIKE ‘log_error’`来定位文件。可从中得到数据库优化的帮助。

```
mysql> show variables like 'log_error'\G
*************************** 1. row ***************************
Variable_name: log_error
        Value: /usr/local/mysql/data/mysqld.local.err
1 row in set (0.00 sec)

mysql> system hostname
wuhua
```
默认情况下错误文件的文件名为服务器的主机名（自己mac下默认安装v5.7.22时使用了默认配置创建了_mysql用户，但是也有wuhua.err日志）。

```
sh-3.2# ps aux | grep mysql | grep -v grep
wuhua            27197   0.0  0.0  4301596   1628 s000  S+   二05下午   0:00.18 mysql -u root -p
_mysql              95   0.0  0.1  4667136   8176   ??  Ss    8 819    0:50.48 /usr/local/mysql/bin/mysqld --user=_mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --plugin-dir=/usr/local/mysql/lib/plugin --log-error=/usr/local/mysql/data/mysqld.local.err --pid-file=/usr/local/mysql/data/mysqld.local.pid --keyring-file-data=/usr/local/mysql/keyring/keyring --early-plugin-load=keyring_file=keyring_file.so
sh-3.2# pwd
/usr/local/mysql/data
sh-3.2# ls -la
total 390208
drwxr-x---   17 _mysql  _mysql       544  8 13 17:50 .
drwxr-xr-x   13 root    wheel        416 10 22  2018 ..
-rw-r-----    1 _mysql  _mysql        56  7  4  2018 auto.cnf
-rw-r-----    1 _mysql  _mysql       559  8  8 17:25 ib_buffer_pool
-rw-r-----    1 _mysql  _mysql  50331648  8  8 17:25 ib_logfile0
-rw-r-----    1 _mysql  _mysql  50331648  7  4  2018 ib_logfile1
-rw-r-----    1 _mysql  _mysql  79691776  8  8 17:25 ibdata1
-rw-r-----    1 _mysql  _mysql  12582912  8 16 15:12 ibtmp1
drwxr-x---    7 _mysql  _mysql       224  9 11  2018 local_test
drwxr-x---   16 _mysql  _mysql       512  7 18 15:55 login
drwxr-x---   77 _mysql  _mysql      2464  7  4  2018 mysql
-rw-r-----    1 _mysql  _mysql   1493892  8 16 14:11 mysqld.local.err
-rw-r-----    1 _mysql  _mysql         3  8  8 17:25 mysqld.local.pid
drwxr-x---   90 _mysql  _mysql      2880  7  4  2018 performance_schema
drwxr-x---  108 _mysql  _mysql      3456  7  4  2018 sys
drwxr-x---    5 _mysql  _mysql       160 11  8  2018 test
-rw-r-----    1 _mysql  _mysql    137797  8 13 17:50 wuhua.err
sh-3.2# tail -n 10 mysqld.local.err 
2019-08-15T03:46:55.758211Z 4 [Note] Aborted connection 4 to db: 'unconnected' user: 'root' host: 'localhost' (Got timeout reading communication packets)
2019-08-15T05:57:18.115284Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 2089426ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-15T10:19:57.114776Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 591037ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-15T12:48:35.002866Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 257282ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T00:45:10.005256Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 42960754ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T02:30:30.003258Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 6316989ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T04:41:49.003687Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 1295395ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T06:09:32.002146Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 68711ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T06:11:12.002422Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 24552ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T07:44:47.528144Z 8 [Note] Access denied for user 'wuhua'@'localhost' (using password: NO)
```

#### 慢查询日志

可帮助定位可能存在问题的SQL语句，从而进行SQL语句层面的优化。

可通过参数`long_query_time`来设置超时阀值，默认10，代表10秒，将运行超过该值的SQL语句记录到慢查询日志文件中。

默认不启动慢查询日志，需要手工将这个参数设置为ON：

```
mysql> show variables like 'long_query_time'\G
*************************** 1. row ***************************
Variable_name: long_query_time
        Value: 10.000000
1 row in set (0.01 sec)

mysql> show variables like 'slow_query_log'\G
*************************** 1. row ***************************
Variable_name: slow_query_log
        Value: OFF
1 row in set (0.00 sec)
```

测试服务器：

```
mysql> show variables like 'long_query_time'\G
*************************** 1. row ***************************
Variable_name: long_query_time
        Value: 2.000000
1 row in set (0.00 sec)

mysql> show variables like 'slow_query_log'\G
*************************** 1. row ***************************
Variable_name: slow_query_log
        Value: ON
1 row in set (0.00 sec)
```

当设置了参数`log_queries_not_using_indexes`为开启时，会将没有使用索引的SQL语句记录到慢查询日志文件。

```
mysql> show variables like 'log_queries_not_using_indexes'\G
*************************** 1. row ***************************
Variable_name: log_queries_not_using_indexes
        Value: OFF
1 row in set (0.00 sec)
```

可通过参数`log_throttle_queries_not_using_indexes`设置每分钟允许记录到slow log的且未使用索引的SQL语句的次数。默认为0表示无限制。

可通过mysqldumpslow命令分析慢查询日志文件。使用参考[mysqldumpslow – 读懂MySQL慢查询日志](http://www.dbhelp.net/2017/01/17/mysqldumpslow-%E8%AF%BB%E6%87%82mysql%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97.html)


v 5.1开始可以将慢查询的日志记录放入到一张表中，在mysql架构下的slow_log表，表结构：

```

mysql> show create table mysql.slow_log\G
*************************** 1. row ***************************
       Table: slow_log
Create Table: CREATE TABLE `slow_log` (
  `start_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `user_host` mediumtext NOT NULL,
  `query_time` time NOT NULL,
  `lock_time` time NOT NULL,
  `rows_sent` int(11) NOT NULL,
  `rows_examined` int(11) NOT NULL,
  `db` varchar(512) NOT NULL,
  `last_insert_id` int(11) NOT NULL,
  `insert_id` int(11) NOT NULL,
  `server_id` int(10) unsigned NOT NULL,
  `sql_text` mediumtext NOT NULL,
  `thread_id` bigint(21) unsigned NOT NULL
) ENGINE=CSV DEFAULT CHARSET=utf8 COMMENT='Slow log'
1 row in set (0.00 sec)
```
显示该表的引擎为CSV，对大数据量下的查询效率不高，可将其转换为MyISAM引擎并在start_time列上添加索引，但是已经启动了慢查询修改会报错，而且更改后会对数据库造成额外的开销。

参数log_output指定了慢查询输出的格式，默认为FILE，指定为TABLE即可将其输出到mysql架构下的slow_log表。

```
mysql> show variables like 'log_output'\G
*************************** 1. row ***************************
Variable_name: log_output
        Value: FILE
1 row in set (0.00 sec)
```

参数`log_output`是动态全局的。

InnoSQl版本加强了对于SQL语句的捕获方式，在原版MySQL数据库的基础上在slow log中增加了对于物理读取（physical reads：从磁盘进行IO读取的次数）和逻辑读取（logic reads：所有的读取，无论磁盘还是缓冲池）的统计。可通过参数`long_query_io`将超过指定逻辑IO次数的SQL语句记录到slow log中，默认为100。为兼容原MySQL数据库的运行方式，还添加了参数`slow_query_type`用来表示启用slow log的方式，可选：
 
* 0 表示不将SQL语句记录到slow log
* 1 表示根据运行时间将SQL语句记录到slow log
* 2 表示根据逻辑IO次数将SQL语句记录到slow log
* 3 表示根据运行时间及逻辑IO次数将SQL语句记录到slow log 


#### 查询日志

记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行，默认文件名为：主机名.log。

```
mysql> show variables like '%general%'\G
*************************** 1. row ***************************
Variable_name: general_log
        Value: OFF
*************************** 2. row ***************************
Variable_name: general_log_file
        Value: /usr/local/mysql/data/wuhua.log
2 rows in set (0.00 sec)
```

本地没有开启查询日志。同slow log，v5.1开始可将查询日志放入mysql架构下的general_log表中。

#### 二进制文件

记录了对MySQL数据库执行更改的所有操作，不包括SELECT和SHOW这类操作。


