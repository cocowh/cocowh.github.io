---
title: 文件
tags: [mysql,note,innodb,file]
comments: true
categories: [MySQL技术内幕-InnoDB存储引擎]
date: 2019-08-16 14:20:30
---

InnoDB存储引擎表的各种类型文件。

* 参数文件：告知MYSQL实例启动时在哪里可以找到数据库文件，并且指定某些初始化参数，这些参数定义了某种内存结构的大小等设置，介绍各种参数的类型。
* 日志文件：记录MySQL实例对某种条件做出响应时写入的文件，如错误的日志文件、二进制日志文件、慢查询日志文件、查询日志文件等。
* socket文件：当用UNIX域套接字方式进行连接时需要的文件。
* pid文件：MySQL实例的进程ID文件。
* MySQL表结构文件：用来存放MySQL表结构定义文件。
* 存储引擎文件：每个存储引擎有自己的文件来保存各种数据。这些存储引擎真正存储了记录和索引等数据。

### 参数文件

默认MySQL实例会按照一定的顺序在指定的位置进行读取，可通过`mysql --help | grep my.cnf`来寻找。

MySQL的mysql架构中记录了访问该实例的权限，当找不到这个架构时，MySQL实例不会启动成功。

#### 什么是参数

可以把数据参数看成一个键/值（Key/Value）对。

MySQL v5.1开始可以通过`information_schema`架构下的`GLOBAL_VARIABLES`试图来进行查找。

```
mysql> select * from global_variables where variable_name like 'innodb_buffer%'\G;
*************************** 1. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_AT_STARTUP
VARIABLE_VALUE: OFF
*************************** 2. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_FILENAME
VARIABLE_VALUE: ib_buffer_pool
*************************** 3. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_DUMP_NOW
VARIABLE_VALUE: OFF
*************************** 4. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_POPULATE
VARIABLE_VALUE: OFF
*************************** 5. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_DUMP_AT_SHUTDOWN
VARIABLE_VALUE: OFF
*************************** 6. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_ABORT
VARIABLE_VALUE: OFF
*************************** 7. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_INSTANCES
VARIABLE_VALUE: 8
*************************** 8. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_SIZE
VARIABLE_VALUE: 4294967296
*************************** 9. row ***************************
 VARIABLE_NAME: INNODB_BUFFER_POOL_LOAD_NOW
VARIABLE_VALUE: OFF
9 rows in set (0.00 sec)
mysql> show variables like 'innodb_buffer%'\G
*************************** 1. row ***************************
Variable_name: innodb_buffer_pool_dump_at_shutdown
        Value: OFF
*************************** 2. row ***************************
Variable_name: innodb_buffer_pool_dump_now
        Value: OFF
*************************** 3. row ***************************
Variable_name: innodb_buffer_pool_filename
        Value: ib_buffer_pool
*************************** 4. row ***************************
Variable_name: innodb_buffer_pool_instances
        Value: 8
*************************** 5. row ***************************
Variable_name: innodb_buffer_pool_load_abort
        Value: OFF
*************************** 6. row ***************************
Variable_name: innodb_buffer_pool_load_at_startup
        Value: OFF
*************************** 7. row ***************************
Variable_name: innodb_buffer_pool_load_now
        Value: OFF
*************************** 8. row ***************************
Variable_name: innodb_buffer_pool_populate
        Value: OFF
*************************** 9. row ***************************
Variable_name: innodb_buffer_pool_size
        Value: 4294967296
9 rows in set (0.00 sec)
```

各版本都支持`SHOW VARIABLES`命令。

#### 参数类型
可分为：

* 动态参数（dynamic）参数，可在MySQL实例运行中进行更改
* 静态（static）参数，在整个实例生命周期内都不得进行更改

可通过SET命令对动态参数值进行更改。

```
SET | [global | session] system_var_name = expr | [@@global. | @@session. | @@]system_var_name= expr
```

global和session关键字表明该参数的修改是基于当前会话还是整个实例的生命周期。有些参数如autocommit只能在会话中进行修改；有些参数如binlog_cache_size修改完后，在整个实例生命周期中都会生效；有些参数如read_buffer_size既可以在会话中修改又可以在整个实例的生命周期内生效。

```
mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> set read_buffer_size=524288;
Query OK, 0 rows affected (0.01 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)
```


```
mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 131072
1 row in set (0.00 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)

mysql> set @@global.read_buffer_size=262144;
Query OK, 0 rows affected (0.00 sec)

mysql> select @@global.read_buffer_size\G
*************************** 1. row ***************************
@@global.read_buffer_size: 262144
1 row in set (0.00 sec)

mysql> select @@session.read_buffer_size\G
*************************** 1. row ***************************
@@session.read_buffer_size: 524288
1 row in set (0.00 sec)
```

动态变量的可修改范围参考MySQL官方手册Dynamic System Variables。

修改静态变量报错，提示静态变量是只读的：

```
mysql> set GLOBAL datadir='/db/mysql';
ERROR 1238 (HY000): Variable 'datadir' is a read only variable
```


### 日志文件

记录MySQL数据库的各种类型活动：

* 错误日志（error log）
* 二进制日志（binlog）
* 慢查询日志（slow query log）
* 查询日志（log）

#### 错误日志

对MySQL的启动、运行、关闭过程进行了记录，可通过`SHOW VARIABLES LIKE ‘log_error’`来定位文件。可从中得到数据库优化的帮助。

```
mysql> show variables like 'log_error'\G
*************************** 1. row ***************************
Variable_name: log_error
        Value: /usr/local/mysql/data/mysqld.local.err
1 row in set (0.00 sec)

mysql> system hostname
wuhua
```
默认情况下错误文件的文件名为服务器的主机名（自己mac下默认安装v5.7.22时使用了默认配置创建了_mysql用户，但是也有wuhua.err日志）。

```
sh-3.2# ps aux | grep mysql | grep -v grep
wuhua            27197   0.0  0.0  4301596   1628 s000  S+   二05下午   0:00.18 mysql -u root -p
_mysql              95   0.0  0.1  4667136   8176   ??  Ss    8 819    0:50.48 /usr/local/mysql/bin/mysqld --user=_mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --plugin-dir=/usr/local/mysql/lib/plugin --log-error=/usr/local/mysql/data/mysqld.local.err --pid-file=/usr/local/mysql/data/mysqld.local.pid --keyring-file-data=/usr/local/mysql/keyring/keyring --early-plugin-load=keyring_file=keyring_file.so
sh-3.2# pwd
/usr/local/mysql/data
sh-3.2# ls -la
total 390208
drwxr-x---   17 _mysql  _mysql       544  8 13 17:50 .
drwxr-xr-x   13 root    wheel        416 10 22  2018 ..
-rw-r-----    1 _mysql  _mysql        56  7  4  2018 auto.cnf
-rw-r-----    1 _mysql  _mysql       559  8  8 17:25 ib_buffer_pool
-rw-r-----    1 _mysql  _mysql  50331648  8  8 17:25 ib_logfile0
-rw-r-----    1 _mysql  _mysql  50331648  7  4  2018 ib_logfile1
-rw-r-----    1 _mysql  _mysql  79691776  8  8 17:25 ibdata1
-rw-r-----    1 _mysql  _mysql  12582912  8 16 15:12 ibtmp1
drwxr-x---    7 _mysql  _mysql       224  9 11  2018 local_test
drwxr-x---   16 _mysql  _mysql       512  7 18 15:55 login
drwxr-x---   77 _mysql  _mysql      2464  7  4  2018 mysql
-rw-r-----    1 _mysql  _mysql   1493892  8 16 14:11 mysqld.local.err
-rw-r-----    1 _mysql  _mysql         3  8  8 17:25 mysqld.local.pid
drwxr-x---   90 _mysql  _mysql      2880  7  4  2018 performance_schema
drwxr-x---  108 _mysql  _mysql      3456  7  4  2018 sys
drwxr-x---    5 _mysql  _mysql       160 11  8  2018 test
-rw-r-----    1 _mysql  _mysql    137797  8 13 17:50 wuhua.err
sh-3.2# tail -n 10 mysqld.local.err 
2019-08-15T03:46:55.758211Z 4 [Note] Aborted connection 4 to db: 'unconnected' user: 'root' host: 'localhost' (Got timeout reading communication packets)
2019-08-15T05:57:18.115284Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 2089426ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-15T10:19:57.114776Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 591037ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-15T12:48:35.002866Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 257282ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T00:45:10.005256Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 42960754ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T02:30:30.003258Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 6316989ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T04:41:49.003687Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 1295395ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T06:09:32.002146Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 68711ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T06:11:12.002422Z 0 [Note] InnoDB: page_cleaner: 1000ms intended loop took 24552ms. The settings might not be optimal. (flushed=0 and evicted=0, during the time.)
2019-08-16T07:44:47.528144Z 8 [Note] Access denied for user 'wuhua'@'localhost' (using password: NO)
```

#### 慢查询日志

可帮助定位可能存在问题的SQL语句，从而进行SQL语句层面的优化。

可通过参数`long_query_time`来设置超时阀值，默认10，代表10秒，将运行超过该值的SQL语句记录到慢查询日志文件中。

默认不启动慢查询日志，需要手工将这个参数设置为ON：

```
mysql> show variables like 'long_query_time'\G
*************************** 1. row ***************************
Variable_name: long_query_time
        Value: 10.000000
1 row in set (0.01 sec)

mysql> show variables like 'slow_query_log'\G
*************************** 1. row ***************************
Variable_name: slow_query_log
        Value: OFF
1 row in set (0.00 sec)
```

测试服务器：

```
mysql> show variables like 'long_query_time'\G
*************************** 1. row ***************************
Variable_name: long_query_time
        Value: 2.000000
1 row in set (0.00 sec)

mysql> show variables like 'slow_query_log'\G
*************************** 1. row ***************************
Variable_name: slow_query_log
        Value: ON
1 row in set (0.00 sec)
```

当设置了参数`log_queries_not_using_indexes`为开启时，会将没有使用索引的SQL语句记录到慢查询日志文件。

```
mysql> show variables like 'log_queries_not_using_indexes'\G
*************************** 1. row ***************************
Variable_name: log_queries_not_using_indexes
        Value: OFF
1 row in set (0.00 sec)
```

可通过参数`log_throttle_queries_not_using_indexes`设置每分钟允许记录到slow log的且未使用索引的SQL语句的次数。默认为0表示无限制。

可通过mysqldumpslow命令分析慢查询日志文件。使用参考[mysqldumpslow – 读懂MySQL慢查询日志](http://www.dbhelp.net/2017/01/17/mysqldumpslow-%E8%AF%BB%E6%87%82mysql%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97.html)


v 5.1开始可以将慢查询的日志记录放入到一张表中，在mysql架构下的slow_log表，表结构：

```

mysql> show create table mysql.slow_log\G
*************************** 1. row ***************************
       Table: slow_log
Create Table: CREATE TABLE `slow_log` (
  `start_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `user_host` mediumtext NOT NULL,
  `query_time` time NOT NULL,
  `lock_time` time NOT NULL,
  `rows_sent` int(11) NOT NULL,
  `rows_examined` int(11) NOT NULL,
  `db` varchar(512) NOT NULL,
  `last_insert_id` int(11) NOT NULL,
  `insert_id` int(11) NOT NULL,
  `server_id` int(10) unsigned NOT NULL,
  `sql_text` mediumtext NOT NULL,
  `thread_id` bigint(21) unsigned NOT NULL
) ENGINE=CSV DEFAULT CHARSET=utf8 COMMENT='Slow log'
1 row in set (0.00 sec)
```
显示该表的引擎为CSV，对大数据量下的查询效率不高，可将其转换为MyISAM引擎并在start_time列上添加索引，但是已经启动了慢查询修改会报错，而且更改后会对数据库造成额外的开销。

参数log_output指定了慢查询输出的格式，默认为FILE，指定为TABLE即可将其输出到mysql架构下的slow_log表。

```
mysql> show variables like 'log_output'\G
*************************** 1. row ***************************
Variable_name: log_output
        Value: FILE
1 row in set (0.00 sec)
```

参数`log_output`是动态全局的。

InnoSQl版本加强了对于SQL语句的捕获方式，在原版MySQL数据库的基础上在slow log中增加了对于物理读取（physical reads：从磁盘进行IO读取的次数）和逻辑读取（logic reads：所有的读取，无论磁盘还是缓冲池）的统计。可通过参数`long_query_io`将超过指定逻辑IO次数的SQL语句记录到slow log中，默认为100。为兼容原MySQL数据库的运行方式，还添加了参数`slow_query_type`用来表示启用slow log的方式，可选：
 
* 0 表示不将SQL语句记录到slow log
* 1 表示根据运行时间将SQL语句记录到slow log
* 2 表示根据逻辑IO次数将SQL语句记录到slow log
* 3 表示根据运行时间及逻辑IO次数将SQL语句记录到slow log 


#### 查询日志

记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行，默认文件名为：主机名.log。

```
mysql> show variables like '%general%'\G
*************************** 1. row ***************************
Variable_name: general_log
        Value: OFF
*************************** 2. row ***************************
Variable_name: general_log_file
        Value: /usr/local/mysql/data/wuhua.log
2 rows in set (0.00 sec)
```

本地没有开启查询日志。同slow log，v5.1开始可将查询日志放入mysql架构下的general_log表中。

#### 二进制文件

binary log记录了对MySQL数据库执行更改的所有操作，不包括SELECT和SHOW这类操作。

作用：

* 恢复：某些数据的恢复需要需要二进制日志。例如再一个数据库全备文件恢复后，可通过二进制日志进行ponit-in-time的恢复。
* 复制：原理与恢复类似，通过复制和执行二进制日志使一台远程的MySQL数据库（一般为slave或standby）与一台MySQL数据库（一般为master或primary）进行实时同步。
* 审计：可通过审计判断是否有对数据库进行注入的攻击。

通过配置参数log-bin [=name]启动二进制日志，不指定name则默认二进制日志文件名为主机名，后缀名为二进制日志的序列号，所在路径为数据库所在目录。

默认没启动，需要手动指定参数启动。影响二进制日志记录的信息和行为：

* max\_binlog\_size：指定单个二进制日志文件的最大值，超过该值产生新的二进制日志文件，后缀名加1，并记录到index文件。
* binlog\_cache\_size：使用事务表存储引擎时，未提交的二进制日志会被记录到一个缓冲中去，等该事务提交时直接将缓冲中的二进制日志写入二进制日志文件，缓冲的大小由binlog\_cache\_size决定，默认为32k。基于session，当一个线程开启事务时会分配一个大小为binlog\_cache\_seze的缓存，若一个事务的记录大于设定的binlog\_cache\_size，会将缓冲中的日志写入一个临时文件。可通过`SHOW GLOBAL STATUS`查看`binlog_cache_use`和`binlog_cache_disk_use`的状态判断当前的设置是否合适，前者记录使用缓冲写二进制日志的次数，后者记录使用临时文件写二进制日志的次数。
* sync\_binlog：表示每写缓冲多少次就同步到磁盘。值1表示采用同步写磁盘的方式来写二进制日志，但是若在事务发出commit之前发生宕机，此时二进制日志写入文件，但是提交还没有发生，在启动恢复时由于二进制日志已经记录了该事务信息，不能被回滚，可通过将参数innodb_support_xa设为1解决，能同时保证二进制日志和InnoDB存储引擎数据文件的同步；默认0。若使用InnoDB存储引擎进行复制，并且想得到最大的高可用行，建议将该值设置为ON。
* binlog\-do\-db和binlog\-ignore-db：表示需要写入或忽略写入哪些库的日志，默认为空，表示需要同步所有库的日志到二进制日志。
* log\-slave\-update：若当前DB是复制中的slave角色，不会将从master取得并执行二进制日志写入自己的二进制日志文件中去，若需要写入则需设置log\-slave\-update。若搭建master=>slave=>slave架构的复制则必须设置该参数。
* bin_format：二进制日志的格式。MySQL v5.1前无此参数，格式基于SQL语句级别，存在问题：若在主服务器上运行rand、uuid等函数或者使用触发器会导致主从服务器上表中数据的不一致；因为二进制日志文件格式的关系默认事务隔离级别为REPEATABLE READ，若使用READ COMMITTED的事务隔离级别会出现丢失更新的现象，出现主从数据库上的数据不一致。

v5.1开始引入参数bin_format可设STATEMENT、ROW和MIXED。
 
 1. STATEMENT格式和之前的版本一样，二进制文件记录的是日志的逻辑SQL语句。
 2. ROW格式下，二进制日志记录表的行更改情况，对Statement格式下的复制问题予以解决，若设置bin_format为ROW，可将InnoDB的事务隔离级别设为READ COMMITTED，以获得更好的并发行。
 3. MIXED格式下，默认采用STATEMENT格式进行二进制日志文件的记录，但在一些情况下会使用ROW格式，可能有：
  * 表的存储引擎为NDB，对表的DML操作都会以ROW格式记录。
  * 使用了UUID()、USER()、CURRENT\_USER()、FOUND\_ROWS()、ROW_COUNT()等不确定函数。
  * 使用了INSERT DELAY语句。
  * 使用了用户定义函数（UDF）
  * 使用了临时表（temeporary table）

binlog_format参数对于存储引擎的限制：

存储引擎 | Row格式 | Statement格式
:-: | :-: | :-:
InnoDB | Y | Y
MyISAM | Y | Y
HEAP | Y | Y
MERGE | Y |Y
NDB | Y | N
Archive | Y | Y
CSV | Y | Y
Federate | Y | Y
Blockhole | N | Y 


通常将参数binlog_format设置为ROW，可为数据库的恢复和复制带来更好的可靠性。有些语句下的ROW格式可能需要更大的容量，会带来二进制文件大小的增加。由于复制是采用传输二进制日志方式实现，复制的网络开销也有所增加。

二进制日志文件需要通过MySQL提供的工具mysqlbinlog工具查看。

[腾讯工程师带你深入解析 MySQL binlog](https://juejin.im/post/5a72c2daf265da3e5234d879)


### 套接字文件

UNIX系统下可采用UINX域套接字方式连接本地MySQL，需要一个套接字文件。

可由参数socket控制，一般在/tmp目录下，名为mysql.sock。

### pid 文件

MySQL实例启动时，会将进程ID写入一个文件——该文件即为pid文件，可由参数pid_file控制，默认位于数据库目录下，文件名为主机名.pid：

```
mysql> show variables  like 'pid_file'\G
*************************** 1. row ***************************
Variable_name: pid_file
        Value: /usr/local/mysql/data/mysqld.local.pid
1 row in set (0.01 sec)

```

### 表结构定义文件

MySQL插件式存储引擎的体系结构的关系，MySQL数据的存储是根据表进行，每个表都有与之对应的文件。无论表采用何种引擎，都有一个以frm为后缀名的文件，记录了该表的表结构定义。frm文件还用来存放视图的定义，文件为文本文件。

查看时发现文件内容像加密过，一查果然，参考[MySQL · 引擎特性 · InnoDB 表空间加密](http://mysql.taobao.org/monthly/2018/04/01/)


### InnoDB存储引擎文件

#### 表空间文件
InnoDB采用存储的数据按表空间（tablespace）进行存放的设计，默认配置下会有一个初始大小为10M名为ibdata1的文件，其为默认的表空间文件，可通过参数innodb\_data\_file\_path对其进行设置。

```
innodb_data_file_path=datafile_spec1[;datafile_spec2]...
```

可通过多个文件组成一个表空间文件，同时制定文件的属性：

```
[mysqld]
innodb_data_file_path = /db/ibdata1:2000M;/dr2/db/ibdata2:2000M:autoextend
```
意味着将/db/ibdata1和/dr2/db/ibdata2两个文件用来组成表空间，大小都为2000MB，若用完可自动增长。若位于不同的磁盘上，磁盘的负载可能被平均，提高数据库的整体性能。

设置该参数后，所有基于InnoDB的表的数据都会记录到该共享表空间中，若设置了参数`innodb_file_pre_table`，则用户可以将每个基于InnoDB存储引擎的产生一个独立表空间，命令规则为：表名.idb。

```
mysql> show variables like 'innodb_file_per_table'\G
*************************** 1. row ***************************
Variable_name: innodb_file_per_table
        Value: ON
1 row in set (0.00 sec)

mysql> system sudo  ls -lh /usr/local/mysql/data/login
total 1424
-rw-r-----  1 _mysql  _mysql    65B  7  5  2018 db.opt
-rw-r-----  1 _mysql  _mysql   8.6K  8 16  2018 jobs.frm
-rw-r-----  1 _mysql  _mysql   112K  8 16  2018 jobs.ibd
-rw-r-----  1 _mysql  _mysql   8.4K  7 19  2018 migrations.frm
-rw-r-----  1 _mysql  _mysql    96K  8 16  2018 migrations.ibd
-rw-r-----  1 _mysql  _mysql   8.4K  7 26  2018 password_resets.frm
-rw-r-----  1 _mysql  _mysql   112K  7 26  2018 password_resets.ibd
-rw-r-----  1 _mysql  _mysql   8.5K  7 26  2018 user_profiles.frm
-rw-r-----  1 _mysql  _mysql   128K  7 27  2018 user_profiles.ibd
-rw-r-----  1 _mysql  _mysql   100B  7 18 16:11 users.MYD
-rw-r-----  1 _mysql  _mysql   2.0K  7 24 09:58 users.MYI
-rw-r-----  1 _mysql  _mysql   8.4K  7 18 15:55 users.frm
-rw-r-----  1 _mysql  _mysql    13K  7 18 15:48 users_old.frm
-rw-r-----  1 _mysql  _mysql   176K  7 18 15:48 users_old.ibd
```
单独的表空间文件仅存储该表的数据、索引和插入缓冲BITMAP等信息，其余信息还是存放在默认的表空间中。

#### 重做日志文件

默认情况下InnoDB存储引擎的数据目录下会有两个名为ib\_logfile0和ib_logfile1的文件。记录了InnoDB存储引擎的事务日志。

当实例或介质失败（media failure）时，InnoDB存储引擎会根据重做日志恢复到掉电前的时刻，以此来保证数据的完整性。

每个InnoDB存储引擎至少有1个重做日志文件组（group），每个文件组下至少有2个重做日志文件，如默认的ib\_logfile0和ib\_logfile1。可设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。日志组中每个重做日志文件的大小一致，并以循环写入的方式运行。

影响重做日志文件的属性：

* innodb\_log\_file\_size：指定每个重做日志文件的大小，InnnoDB v1.2.x前总大小小于等于4GB，v1.2.x将限制扩大为512GB。
* innodb\_log\_files\_in\_group：指定日志文件组中重做日志文件的数量，默认为2。
* innodb\_mirrored\_log\_groups：指定了日志镜像文件组的数量，默认为1，表示只有一个日志文件组，没有镜像。若磁盘本身已做了高可用方案，如磁盘列阵，则可以不开启重做日志镜像的功能。
* innodb\_log\_group\_home\_dir：指定了日志文件组所在的路径，默认为./，表示在MySQL数据库的数据目录下。

```
mysql> system sudo  ls -lh /usr/local/mysql/data
Password:
total 390208
-rw-r-----    1 _mysql  _mysql    56B  7  4  2018 auto.cnf
-rw-r-----    1 _mysql  _mysql   559B  8  8 17:25 ib_buffer_pool
-rw-r-----    1 _mysql  _mysql    48M  8  8 17:25 ib_logfile0
-rw-r-----    1 _mysql  _mysql    48M  7  4  2018 ib_logfile1
-rw-r-----    1 _mysql  _mysql    76M  8  8 17:25 ibdata1
-rw-r-----    1 _mysql  _mysql    12M  8 16 15:12 ibtmp1
drwxr-x---    7 _mysql  _mysql   224B  9 11  2018 local_test
drwxr-x---   16 _mysql  _mysql   512B  7 18 15:55 login
drwxr-x---   77 _mysql  _mysql   2.4K  7  4  2018 mysql
-rw-r-----    1 _mysql  _mysql   1.4M  8 19 13:43 mysqld.local.err
-rw-r-----    1 _mysql  _mysql     3B  8  8 17:25 mysqld.local.pid
drwxr-x---   90 _mysql  _mysql   2.8K  7  4  2018 performance_schema
drwxr-x---  108 _mysql  _mysql   3.4K  7  4  2018 sys
drwxr-x---    5 _mysql  _mysql   160B 11  8  2018 test
-rw-r-----    1 _mysql  _mysql   135K  8 13 17:50 wuhua.err
```
重做日志文件设置过大会导致恢复需要很长的时间，太小会导致一个事务需要多次切换重做日志文件。此外太小会导致频繁地发生async checkpoint，导致性能的抖动。

二进制日志记录所有与MySQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等其他存储引擎的日志，InnoDB存储引擎的重做日志只记录有关该存储引擎本身的事务日志。二进制日志记录的是关于一个事务的具体操作内容，该日志是逻辑日志，InnoDB存储引擎的重做日志记录的是关于每个页的更改的物理情况。二进制日志文件仅在事务提交前进行提交，只写磁盘一次，不论该事务多大，在事务进行的过程中，不断有重做日志被写入到重做日志文件中。

到InnoDB v1.2.x版本为止，共定义了51种重做日志类型，基本格式相同：

redo\_log\_type | space | page_no | redo\_log\_body
:-: | :-: | :-: | :-: 
占用1字节，表示重做日志的类型 | 表示表空间的ID，采用压缩的方式，占用空间可能小于4字节 | 表示页的偏移量，采用压缩的方式 | 表示每个重做日志的数据部分，恢复时需要调用相应的函数进行解析

从重做日志缓冲往磁盘写入时按照512个字节（一个扇区）的大小进行写入，因为扇区是写入的最小单位，可以保证写入必定是成功的。重做日志的写入过程中不需要有doublewrite。

参数`innodb_flush_log_at_trx_commit`控制在提交时，处理重做日志的方式：

* 0 ：表示当事务提交时，不将事务的重做日志写入磁盘上的日志文件，而是等待主线程每秒的刷新。
* 1 ：执行commit时将重做日志缓冲同步写到缓存中，伴有fsync的调用。
* 2 ：表示将重做日志异步写到磁盘，即写到文件系统的缓存中，不能完全保证执行commit时肯定会写入重做日志文件，只是有这个动作发生。

为保证ACID中的持久性，必须将innodb\_flush\_log\_at\_trx_commit设为1，即每档事务提交时就必须确保事务已经写入重做日志文件，当数据库意外宕机时可以通过重做日志文件恢复，并保证可以恢复已经提交的事务。设为0或2时，都有可能发生恢复时部分事务的丢失，但是设置为2若MySQL数据库宕机而操作系统及服务器没有宕机时，由于此时为写入磁盘的事务日志保存在文件系统缓冲中，恢复时同样能保证数据不丢失。